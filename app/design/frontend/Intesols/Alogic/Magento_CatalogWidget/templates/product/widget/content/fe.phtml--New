<?php
/**
 * Copyright Â© 2016 Magento. All rights reserved.
 * See COPYING.txt for license details.
 */

// @codingStandardsIgnoreFile

?>
<?php
/**
 * Template for displaying products list widget
 *
 * @var $block \Magento\CatalogWidget\Block\Product\ProductsList
 */
 
 
 $objectManager = \Magento\Framework\App\ObjectManager::getInstance();
/** @var \Magento\Catalog\Model\ResourceModel\Product\Collection $productCollection */
$productCollection = $objectManager->create('Magento\Catalog\Model\ResourceModel\Product\Collection');
/** Apply filters here */
 $collection = $productCollection->addAttributeToSelect('*')->addAttributeToFilter('is_featured_product', 1)->load();
 $image = 'category_page_list';
 $store = $objectManager->get('Magento\Store\Model\StoreManagerInterface')->getStore();

?>


     <div id="owl-demo-fe" class="owl-carousel subcat-pros">
         <?php $count=0; foreach ($collection as $product) {
             $count++;
             if ($count <= 15) { ?>

                 <div class="subcat-pro item">
                     <?php $productImage = $product->getImage($product, 'new_products_content_widget_grid'); ?>

                     <div class="search-product-image">
                         <a href="<?php /* @escapeNotVerified */
                         echo $product->getProductUrl() ?>" class="product photo product-item-photo  <?php  echo $product->getResource()->getAttribute('is_featured_product')->getFrontend()->getValue($product).'jayssss'; ?>"
                            tabindex="-1">
                             <img src="<?php echo $imageUrl = $store->getBaseUrl(\Magento\Framework\UrlInterface::URL_TYPE_MEDIA) . 'catalog/product' . $productImage; ?>"/>
                         </a>
                     </div>
                     <div class="ptitle">
                         <a href="<?php /* @escapeNotVerified */
                         echo $product->getProductUrl() ?>" class="ptext" tabindex="-1">
                             <?php echo $product->getName(); ?><?php echo $product->getIsSale(); ?>
                         </a>
                     </div>
                     <?php if ($product->getData('show_for_sale') == 1) { ?>
                         <div class="cate-pro-price">
                             <?php
                             $priceHelper = $objectManager->create('Magento\Framework\Pricing\Helper\Data'); // Instance of Pricing Helper
                             $p = $product->getFinalPrice();
							 $p = $product->getPriceInfo()->getPrice('final_price')->getAmount()->getValue();
                              echo $formattedPrice = $priceHelper->currency($p, true, false);
							 
                             ?></div>
                     <?php } else { ?>
					 <div class="nocart">
                               <div class="buyatcall">
											<a href="javascript:void(0);" id="showresllerbtb<?php echo $product->getId(); ?>" title="Where to Buy" class="action primary tocart popuptrigger">
												<span><?php echo "Where to Buy"; ?></span>
											</a>
											
											<?php
											$objectManager1 = \Magento\Framework\App\ObjectManager::getInstance();
											$__modelDistributorFactory = $objectManager1->create('Intesols\Distributor\Model\DistributorFactory');
											//echo "<span style='display:none'>".$product->getReseller()."</span>";
											$nationalIdArray = explode(',', $product->getData('national_retailer'));
											$resellerIdArray = explode(',', $product->getData('reseller'));
											$distributorIdArray = explode(',', $product->getDistributor());

											$distributorModel = $__modelDistributorFactory->create();
											$resellerModel = $distributorModel->getCollection()->addFieldToFilter('id', array('in' => $resellerIdArray));
											$nationalModel = $distributorModel->getCollection()->addFieldToFilter('id', array('in' => $nationalIdArray));
											$distributorModel = $distributorModel->getCollection()->addFieldToFilter('id', array('in' => $distributorIdArray));
											$productTypeInstance = $product->getTypeInstance();
                                            if ($product->getTypeId() == \Magento\ConfigurableProduct\Model\Product\Type\Configurable::TYPE_CODE) {
												 $_children1 = $product->getTypeInstance()->getUsedProducts($product);
												 foreach ($_children1 as $child1) {
													 
													 $sku1 = $child1->getSku();
													 break;
												 }
											 } else {
												 
												 $sku1 = $product->getSku();
											 }										
											?>
											
											<div id="popup-container" class="ressler-pop <?php echo $product->getSku(); ?>">
												<a class="close"><i class="fa fa-times" aria-hidden="true"></i></a>
												  <div id="popup-window">
													<div class="modal-content">
													<div class="wdpu-head"> 
													<div class="wdpu-title">
													<a href="javascript:void(0);"><img src="<?php echo $block->getUrl().'pub/media/Reseller-icon.png'; ?>" alt="Resellers" /></a>
													</div> 
													<div class="wdpu-subtitle"><span>View Resellers</span></div> 
													</div> 
													<div class="allresler">
														<div id="reseller-container" class="">														
																<ul>
																   <?php foreach($nationalModel as $reseller){	
																			$reseller_url = $reseller->getSearchString();
																			//$reseller_url = str_replace("{{sku}}",$first_sku,$reseller_url);
																	?>
																	
																		<li>						
																			<a target="_blank" href="<?php echo str_replace('{{sku}}',$sku1,$reseller_url); ?>"><img width="125" height="100" src="<?php echo $this->getUrl('pub/media').$reseller->getLogo() ?>" alt="<?php echo $reseller->getName() ?>" /></a>
																		</li>
																	<?php
																	}
																	foreach($resellerModel as $reseller){	
																			$reseller_url = $reseller->getSearchString();
																			
																			//$reseller_url = str_replace("{{sku}}",$first_sku,$reseller_url);
																		?>
																		<li>						
																			<a target="_blank" href="<?php echo str_replace('{{sku}}',$sku1,$reseller_url); ?>"><img width="125" height="100" src="<?php echo $this->getUrl('pub/media').$reseller->getLogo() ?>" alt="<?php echo $reseller->getName() ?>" /></a>
																		</li>
																	<?php } ?>
																</ul>	
																
																  
														</div>
													</div>
													</div>
												  </div>							  					  
					                        </div>
							
                                           							
					            </div>
					    </div>
					<?php } ?>
					 
                     <?php


                     echo $block->getProductDetailsHtml($product); ?>

                         <a title="Add to Cart" class="action tocart primary"
                            href="<?php echo $product->getProductUrl() ?>">
                             <span>View Details</span>
                         </a>                        
                    
					  <?php echo $block->getReviewsSummaryHtml($product, "sort", true); ?>
                     <div class="psku">
                         <?php
                         $barcode = "";
                         if ($product->getTypeId() == \Magento\ConfigurableProduct\Model\Product\Type\Configurable::TYPE_CODE) {
                             $_children = $product->getTypeInstance()->getUsedProducts($product);
                             foreach ($_children as $child) {
                                 $barcode = $child->getBarcodeEan();
                                 $sku = $child->getSku();
                                 break;
                             }
                         } else {
                             $barcode = $product->getBarcodeEan();
                             $sku = $product->getSku();
                         }
                         echo $sku; ?> </div>

                 </div>
             <?php }
         } ?>
	  </div>
	   <div class="customNavigation">
                        <a class="btn prev-fe"><i class="fa fa-chevron-circle-left"
                                                                       aria-hidden="true"></i></a>
                        <a class="btn next-fe"><i class="fa fa-chevron-circle-right"
                                                                       aria-hidden="true"></i></a>
                    </div>
					
<?php /* popup Script */ ?>
<script>
jQuery(document).ready(function() {
	
	jQuery('#popup-container a.close').click(function(){
			jQuery('#popup-container').fadeOut();
			jQuery('#active-popup').fadeOut();
			jQuery('#active-popup').hide();
            jQuery('.wrap-unwrap').hide();
            jQuery('.ressler-pop').hide();
			jQuery('body').removeClass('mpopup');
	});
	jQuery('.ressler-pop a.close').click(function(){
			jQuery('.ressler-pop').fadeOut();
			jQuery('#active-popup').fadeOut();
			jQuery('#active-popup').hide();
            jQuery('.wrap-unwrap').hide();
            jQuery('.ressler-pop').hide();
			jQuery('body').removeClass('mpopup');
	});
	
	jQuery('#showdist').click(function(){
		setTimeout( function(){ 
			   var pageHeight = jQuery(document).height();
						jQuery('<div id="active-popup"></div>').insertBefore('body');
						jQuery('#active-popup').css("height", pageHeight);
						jQuery('.distributors-pop').show();
						jQuery('body').addClass('mpopup');
			}  , 10 );
		
	});
	// jQuery('#showresller').click(function(){
		// setTimeout( function(){ 
			   // var pageHeight = jQuery(document).height();
						// jQuery('<div id="active-popup"></div>').insertBefore('body');
						// jQuery('#active-popup').css("height", pageHeight);
						// jQuery('.ressler-pop').show();
						// jQuery('body').addClass('mpopup');
			// }  , 10 );
		
	// });
	
	jQuery('#active-popup').on( "click", "a",function() {
			console.log("clicked");
			jQuery('#popup-container').fadeOut();
			jQuery('#active-popup').fadeOut();
			//jQuery('#active-popup').remove();
			jQuery('body').removeClass('mpopup');
		    jQuery('.ressler-pop').hide();
			jQuery('#active-popup').fadeOut();
            jQuery('.wrap-unwrap').fadeOut();
			//jQuery('#active-popup').remove();
			jQuery('body').removeClass('mpopup');
		
	});
		
	
});

require(['jquery'],function($){	
	jQuery( document ).ready(function() {
			jQuery('body').click(function() {
			jQuery('#popup-container').fadeOut();
			jQuery('#active-popup').fadeOut();
			//jQuery('#active-popup').remove();
			jQuery('body').removeClass('mpopup');
			//jQuery('.ressler-pop').fadeOut();
	});
	 

	// jQuery('#active-popup').click(function() {
 //            console.log("unclicked");
	// 		jQuery('#popup-container').fadeOut();
	// 		jQuery('#active-popup').fadeOut();
	// 		jQuery('#active-popup').remove();
	// 		jQuery('body').removeClass('mpopup');
	// 		//jQuery('.ressler-pop').fadeOut();
	// });
		
	});	
	
	
	
});


</script>
<script>
		jQuery('.price-box').css("display", "block");
		jQuery(document).on('click','a.popuptrigger',function(){
			var test = jQuery(this).siblings('.ressler-pop').wrap('<div id="active-popup" class="wrap-unwrap"></div>');
			var str = test.parent().html();
			// console.log(str);
			jQuery(this).siblings('.ressler-pop').html(str);
			jQuery(this).siblings('.wrap-unwrap').css("height", jQuery(document).height());
			jQuery(this).siblings('.wrap-unwrap').css("position", 'fixed');
			jQuery(this).siblings('.wrap-unwrap').show();
			jQuery('body').addClass('mpopup');
			jQuery(this).siblings('div').children('.ressler-pop').show();
			console.log(jQuery(this).siblings('.ressler-pop'));
		});
</script>
<?php /* popup Script */ ?>
					
					
					
<script>

jQuery(document).ready(function () {
				var d = jQuery('.ves-inner.container').width();
				jQuery('#owl-demo-fe').css('width',d+'px');
                if(d <= 480)
                            { var p = d - 20;
                                jQuery('#owl-demo-fe').css('width',p+'px');
                                jQuery('#owl-demo-fe').css('margin','0 auto');
                            } else {
                                jQuery('#owl-demo-fe').css('width',d+'px');    
                            }

			jQuery("#owl-demo-fe").owlCarousel({
            loop:true,
			nav:false,
			dots: false,		
            margin:50,
			pagination : false,
            responsiveClass:true,

          responsive: {
                        0: {
                            items: 1,
                            nav: true,
                            margin:50
                            
                        },
                        480: {
                            items: 2,
                            nav: true
                        },
						768: {
                            items: 2,
                            nav: false
                        },
                        1024: {
                            items: 3,
                            nav: false
                        },
                        1199: {
                            items: 4,
                            nav: true,
                            loop: false
                        }
                    }
		});
				jQuery(".next-fe").click(function (e) {
                    jQuery("#owl-demo-fe").trigger('next.owl.carousel');                    
                });
                jQuery(".prev-fe").click(function (e) {                    
                    jQuery("#owl-demo-fe").trigger('prev.owl.carousel');
                });



		
});			
jQuery( window ).resize(function() {
  			var d = jQuery('.ves-inner.container').width();
            if(d <= 320)
                { var p = d - 20;
                    jQuery('#owl-demo-fe').css('width',p+'px');
                } else {
                    jQuery('#owl-demo-fe').css('width',d+'px');    
                }
				
});
</script>

<script>
    jQuery(window).load(function () {
        setTimeout(function () {
            var dp = 0;
            jQuery("#owl-demo-fe .owl-item").each(function () {
				jQuery('#owl-demo-fe .owl-item').css('height', '');
                var hs = jQuery(this).height();
                if (hs > dp) {
                    dp = hs;
                }
            });

            var msss = dp + parseInt(19);

            jQuery('#owl-demo-fe .owl-item').css('height', msss + 'px');
			console.log('onload');
        }, 3000);


    });

    jQuery(window).resize(function () {

        var dp = 0;
        jQuery("#owl-demo-fe .owl-item").each(function () {
			jQuery('#owl-demo-fe .owl-item').css('height', '');
            var hs = jQuery(this).height();
            if (hs > dp) {
                dp = hs;
            }
        });
        var msss = dp + parseInt(19);
        jQuery('#owl-demo-fe .owl-item').css('height', dp + 'px');
			console.log('onresize');
    });
</script>

